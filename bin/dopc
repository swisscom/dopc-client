#!/usr/bin/env ruby

require 'gli'
require 'base64'
require 'rest-client'
require 'dopc'

include GLI::App

program_desc 'CLI client for DOPc. For general errors the client will exit with 1. For an invalid plan file it exits with 65.'

version Dopc::VERSION

subcommand_option_handling :normal
arguments :strict

desc 'URL where DOPc service runs'
default_value 'http://localhost:3000'
arg_name 'url'
flag [:u, :url]

desc 'API version to use'
default_value '1'
arg_name 'api'
flag [:a, :api]

desc 'Show debug output'
switch [:d, :debug]

def api(options, method, path, payload = nil)
  client = Dopc::ApiClient.new(options[:url], options[:api])
  begin
    body = client.request(method, path, payload)
    return body.empty? ? {} : JSON.parse(body)
  rescue RestClient::Exception => e
    body = e.response.body
    error = body.empty? ? 'Unknown' : JSON.parse(body)['error']
    exit_now!(error, 1)
  end
end

pre do |global_options,command,options,args|
  ENV['GLI_DEBUG'] = 'true' if global_options[:debug]
  true
end

desc 'Ping the API'
command :ping do |c|
  c.action do |global_options, options, args|
    response = api(global_options, :get, 'ping')
    puts response['pong']
  end
end

desc 'Manage plans'
command :plan do |c|
  c.desc 'List all plans'
  c.command :list do |sc|
    sc.action do |global_options, options, args|
      response = api(global_options, :get, 'plans')
      response['plans'].each { |plan| puts plan['name'] }
    end
  end
  c.arg_name 'name'
  c.desc 'Get a plan'
  c.command :get do |sc|
    sc.action do |global_options, options, args|
      help_now!('Specify plan to retrieve') if args.empty?
      name = args[0]
      response = api(global_options, :get, "plans/#{name}")
      content = Base64.decode64(response['content'])
      puts content
    end
  end
  c.arg_name 'file'
  c.desc 'Add a plan'
  c.command :add do |sc|
    sc.action do |global_options, options, args|
      help_now!('Specify plan file to add') if args.empty?
      file = args[0]
      content = Base64.encode64(File.read(file))
      payload = {content: content}
      response = api(global_options, :post, 'plans', payload)
      puts "Added plan: #{response['name']}"
    end
  end
  c.arg_name 'file'
  c.desc 'Update a plan'
  c.command :update do |sc|
    sc.desc 'Plan file to update from'
    sc.arg_name 'file'
    sc.flag [:f, :file]
    sc.action do |global_options, options, args|
      help_now!('Specify plan to update') if args.empty?
      plan = args[0]
      file = options[:file]
      content = Base64.encode64(File.read(file))
      payload = {content: content}
      response = api(global_options, :put, "plans/#{plan}", payload)
      puts "Updated plan: #{response['name']}"
    end
  end
  c.arg_name 'name'
  c.desc 'Delete a plan'
  c.command :del do |sc|
    sc.action do |global_options, options, args|
      help_now!('Specify plan to delete') if args.empty?
      name = args[0]
      response = api(global_options, :delete, "plans/#{name}")
      puts "Deleted plan: #{response['name']}"
    end
  end
  c.arg_name 'name'
  c.desc 'Check a plan'
  c.command :check do |sc|
    sc.action do |global_options, options, args|
      help_now!('Specify plan to delete') if args.empty?
      name = args[0]
      response = api(global_options, :get, "plans/#{name}/check")
      exit_now!("Plan is invalid", 65) unless response['valid']
    end
  end
end

desc 'Manage plan executions'
command :exec do |c|
  c.desc 'List all executions'
  c.command :list do |sc|
    sc.action do |global_options, options, args|
      response = api(global_options, :get, 'executions')
      response['executions'].each { |exec| puts "#{exec['id']}, #{exec['plan']}, #{exec['status']}" }
    end
  end
  c.arg :name
  c.desc 'Execute a plan (deploy with DOPv and run with DOPi)'
  c.command :new do |sc|
    sc.switch :dopi, desc: 'Enable/disable running plan with DOPi', default_value: true
    sc.switch :dopv, desc: 'Enable/disable deploying plan with DOPv', default_value: true
    sc.flag [:s, :stepset], desc: 'Stepset to run instead of the default'
    sc.action do |global_options, options, args|
      help_now!('Specify plan to execute') if args.empty?
      name = args[0]
      stepset = options[:stepset]
      payload = {plan: name, dopi: options[:dopi], dopv: options[:dopv]}
      stepset ? payload.merge({stepset: stepset}) :
      response = api(global_options, :post, "executions", payload)
      puts "Started execution with id: #{response['id']}"
    end
  end
end

exit run(ARGV)
